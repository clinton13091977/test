<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Smart Bio - Digital Service Report</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- Signature & PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6fa; margin:0; padding:0;}
.container { max-width:800px; margin:20px auto; background:#fff; padding:12px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
header { text-align:center; margin-bottom:10px; background:#0d4f8b; color:#fff; padding:8px; border-radius:6px;}
header img { max-width:70px; display:block; margin:0 auto 4px;}
header h1 { font-size:14px; margin:0; font-weight:bold;}
.section { margin-top:10px; padding:8px; border:1px solid #dce3ef; border-radius:6px;}
.section h3 { margin:0 0 6px 0; font-size:12px; color:#0d4f8b; border-bottom:1px solid #ddd; padding-bottom:3px;}
.form-row { display:flex; align-items:center; margin-bottom:6px;}
label { font-weight:bold; font-size:11px; display:inline-block; width:120px;}
input, select, textarea { flex:1; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px;}
button { padding:6px 10px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:11px; }
.btn-primary { background:#0d4f8b; color:#fff; }
.btn-danger { background:#d62828; color:#fff; }
.controls { margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
.sig-preview { margin-top:4px; max-width:180px; border:1px solid #ccc; display:block; margin-left:auto; margin-right:auto;}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000;}
.modal-inner { background:#fff; width:320px; border-radius:6px; display:flex; flex-direction:column; padding:10px; }
.modal-inner input, .modal-inner textarea { margin-bottom:8px; padding:4px; border:1px solid #ccc; border-radius:4px;}
.logout-btn { margin-top:8px; background:#d62828; color:#fff; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px; }
table { width:100%; border-collapse:collapse; margin-top:8px; font-size:10px;}
th,td { border:1px solid #ccc; padding:3px; text-align:center;}
th { background:#eef6ff;}
.note { font-size:9px; font-style:italic; margin-top:4px; }
</style>
</head>
<body>

<div id="authContainer" class="container">
  <img src="logo.jpg" alt="Company Logo" style="max-width:100px;margin-bottom:10px;">
  <h2>Smart Bio</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <select id="role">
    <option value="user">User</option>
    <option value="engineer">Biomedical Engineer</option>
  </select>
  <div class="controls">
    <button class="btn-primary" onclick="authAction()">Login / Sign Up</button>
  </div>
</div>

<!-- USER FORM -->
<div id="userForm" class="container" style="display:none;">
  <header>
    <img src="logo.jpg" alt="Company Logo">
    <h1>Digital Service Report - Complaint</h1>
  </header>
  <button class="logout-btn" onclick="logout()">Logout</button>
  <div class="section">
    <h3>Register Complaint</h3>
    <div class="form-row"><label>Department</label><input id="deptUser" type="text"></div>
    <div class="form-row"><label>Equipment</label><input id="equipUser" type="text"></div>
    <div class="form-row"><label>Serial No.</label><input id="serialUser" type="text"></div>
    <div class="form-row"><label>Problem</label><textarea id="problemUser"></textarea></div>
    <div class="controls">
      <button class="btn-primary" onclick="openSignature('user')">Sign</button>
      <button class="btn-primary" onclick="submitComplaint()">Submit</button>
    </div>
    <img id="userSignImg" class="sig-preview">
  </div>
</div>

<!-- ENGINEER DASHBOARD -->
<div id="engineerDashboard" class="container" style="display:none;">
  <header>
    <img src="logo.jpg" alt="Company Logo">
    <h1>Engineer Dashboard</h1>
  </header>
  <button class="logout-btn" onclick="logout()">Logout</button>
  <table id="complaintTable">
    <thead><tr><th>ID</th><th>Dept</th><th>Equip</th><th>Problem</th><th>Status</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Signature Modal -->
<div id="sigModal" class="modal">
  <div class="modal-inner">
    <canvas id="sigCanvas" style="border:1px solid #000; height:200px;"></canvas>
    <div class="controls">
      <button class="btn-primary" onclick="acceptSignature()">Accept</button>
      <button class="btn-danger" onclick="clearSignature()">Clear</button>
      <button onclick="closeSignature()">Close</button>
    </div>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAWPlgLt8OQPX6Gq6hzsp46VZxSxXIU5i0",
  authDomain: "digital-service-report.firebaseapp.com",
  projectId: "digital-service-report",
  storageBucket: "digital-service-report.appspot.com",
  messagingSenderId: "783895149200",
  appId: "1:783895149200:web:01c08a62d429bf1bf8f615"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let currentUser="", currentRole="", signer="", sigPad="";

// AUTH
function authAction(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  const role=document.getElementById("role").value;

  auth.signInWithEmailAndPassword(email,password)
    .then(cred=>{
      currentUser=cred.user.uid; currentRole=role;
      document.getElementById("authContainer").style.display="none";
      if(role==="user") document.getElementById("userForm").style.display="block";
      else if(role==="engineer") { document.getElementById("engineerDashboard").style.display="block"; loadComplaints(); }
    }).catch(err=>{
      // Auto sign up if user not exists
      auth.createUserWithEmailAndPassword(email,password)
      .then(()=>{ alert("User registered. Please login."); })
      .catch(e=>alert(e.message));
    });
}

function logout(){ auth.signOut().then(()=>location.reload()); }

// USER COMPLAINT
function submitComplaint(){
  if(!document.getElementById("userSignImg").src){
    alert("Please sign first!"); return;
  }
  if(!confirm("Submit complaint?")) return;
  const data={
    dept: document.getElementById("deptUser").value,
    equip: document.getElementById("equipUser").value,
    serial: document.getElementById("serialUser").value,
    problem: document.getElementById("problemUser").value,
    userSign: document.getElementById("userSignImg").src,
    status:"open",
    created: firebase.firestore.FieldValue.serverTimestamp()
  };
  db.collection("complaints").add(data).then(()=>{
    alert("Complaint submitted!"); 
    document.getElementById("deptUser").value="";
    document.getElementById("equipUser").value="";
    document.getElementById("serialUser").value="";
    document.getElementById("problemUser").value="";
    document.getElementById("userSignImg").src="";
  });
}

// LOAD COMPLAINTS FOR ENGINEER
function loadComplaints(){
  const tbody=document.querySelector("#complaintTable tbody");
  db.collection("complaints").orderBy("created","desc").onSnapshot(snapshot=>{
    tbody.innerHTML="";
    snapshot.forEach(doc=>{
      const c = doc.data();
      let actionButtons="";
      if(c.status==="open") actionButtons=`<button onclick="closeComplaint('${doc.id}')">Close</button>`;
      else actionButtons=`<button onclick="viewPDF('${doc.id}')">View PDF</button>`;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${doc.id}</td><td>${c.dept}</td><td>${c.equip}</td><td>${c.problem}</td><td>${c.status}</td><td>${actionButtons}</td>`;
      tbody.appendChild(tr);
    });
  });
}

// ENGINEER CLOSE COMPLAINT
function closeComplaint(id){
  signer="engineer";
  const action = prompt("Action Taken:");
  if(!action) return;
  openSignature("engineer");
  document.getElementById("sigModal").dataset.complaintId=id;
  document.getElementById("sigModal").dataset.actionTaken=action;
}

// SIGNATURE
function openSignature(role){
  signer=role;
  document.getElementById("sigModal").style.display="flex";
  const canvas=document.getElementById("sigCanvas");
  canvas.width=canvas.offsetWidth*2; canvas.height=canvas.offsetHeight*2;
  canvas.getContext("2d").scale(2,2);
  sigPad=new SignaturePad(canvas,{penColor:"black"});
}

function acceptSignature(){
  if(sigPad.isEmpty()){ alert("Please sign first!"); return; }
  const dataUrl = sigPad.toDataURL();
  if(signer==="user") document.getElementById("userSignImg").src=dataUrl;
  else if(signer==="engineer"){
    const id = document.getElementById("sigModal").dataset.complaintId;
    const actionTaken = document.getElementById("sigModal").dataset.actionTaken;
    db.collection("complaints").doc(id).get().then(doc=>{
      const c = doc.data();
      db.collection("complaints").doc(id).update({status:"closed", actionTaken:actionTaken, engineerSign:dataUrl}).then(async()=>{
        // Generate PDF and upload
        const pdfContent=`
          <h3>Complaint ID: ${id}</h3>
          <p><b>Dept:</b> ${c.dept}</p>
          <p><b>Equipment:</b> ${c.equip}</p>
          <p><b>Serial No:</b> ${c.serial}</p>
          <p><b>Problem:</b> ${c.problem}</p>
          <p><b>Action Taken:</b> ${actionTaken}</p>
          <p><b>User Signature:</b><br><img src="${c.userSign}" width="180"></p>
          <p><b>Engineer Signature:</b><br><img src="${dataUrl}" width="180"></p>`;
        const div=document.createElement("div"); div.innerHTML=pdfContent;
        const canvas=await html2canvas(div,{scale:2});
        const img=canvas.toDataURL("image/jpeg",0.98);
        const pdf=new jspdf.jsPDF("p","mm","a4");
        const pageWidth=pdf.internal.pageSize.getWidth();
        const pageHeight=pdf.internal.pageSize.getHeight();
        const imgProps=pdf.getImageProperties(img);
        const pdfHeight=(imgProps.height*pageWidth)/imgProps.width;
        const scaleFactor = pageHeight/pdfHeight <1 ? pageHeight/pdfHeight : 1;
        pdf.addImage(img,"JPEG",0,0,pageWidth,pdfHeight*scaleFactor);
        const pdfBlob = pdf.output("blob");
        const storageRef = storage.ref().child("complaints/Complaint_" + id + ".pdf");
        storageRef.put(pdfBlob).then(()=>alert("Complaint closed and PDF uploaded!"));
      });
    });
  }
  closeSignature();
}

function clearSignature(){ sigPad.clear(); }
function closeSignature(){ document.getElementById("sigModal").style.display="none"; }

// VIEW PDF
function viewPDF(id){
  const storageRef = storage.ref().child("complaints/Complaint_" + id + ".pdf");
  storageRef.getDownloadURL().then(url=>window.open(url,"_blank")).catch(()=>alert("PDF not found"));
}
</script>
</body>
</html>
